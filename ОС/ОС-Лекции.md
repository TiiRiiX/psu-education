# Операционные системы

Рябинин Константин Валентинович

kostya.ryabinin@gmail.com

## ОС как ядро программного обеспечения

Примеры операционных системы:

* Desktop
  * Solaris
  * Windows
  * GNU/Linux
  * macOS
* Mobile
  * Android
  * iOS

**IoT** (интернет вещей) - это сеть связанных через интернет объектов, способных собирать данные и обмениваться данными, поступающими со встроенных сервисов.

**ENIAC** (14.02.1945) (*Electronic Numerical Integrator and Computer*) - первый электронный цифровой вычислитель общего назначения, который можно было перепрограммировать для решения широкого спектра задач.

**Вычислетельная система** - один или несколько компьютеров, объедененных для решения одной задачи.

**Програмное обеспечение** - весь комплекс программ, установленых в вычислетильное системе + программная документация:

* Прикладное (ППО)
  * MS Paint
  * MS Word
  * Photoshop
* Системное (СПО) - решает задачи без конкретнной предметной области
  * ОС
  * Драйверы оборудования
  * Антивирусы
  * Системы программирования
* Другие (промежуточные между СПО и ППО)
  * СУБД

**ОС** как ядро современного ПО

**ОС** - комплекс программ предназначенных для эффективной организации вычислительного процесса в соответсвии с заданным режимом выполнения программ дерективами программиста и указаниями пользователя.

**Цель ОС** - минимизация вмешательства человека в вычислительный процесс.

**Функции ОС**:

* Управление устройствами
* Управление процессами
* Управление данными
* Взаимодействие с пользователем

**Расширенная машина** (РМ) - компьютер с установленным на нем ПО.
РМ = Железо + ПО

Уровни РМ:

1. ППО
2. Утилиты | Компиляторы | Интерпритатор
3. ОС
4. Микроархитектура
5. Физические устройства

> 4 и 5 - железо (hardware)
> 1, 2, 3 - ПО (software)
> 2 и 3 - СПО
> Разработчик аппаратуры работает с 4 и 5
> Разработчик ОС, программисты, немного пользователи работают с 3
> Драйвер (утилиты) работает с микроархитектурой, но через ОС
> Пользователи и чуть чуть програмисты работают с ППО

**Архитектура** - абстрактное представление системы с точки зрения пользователя или программиста.

ОС состоит из

1. API | UI (PAPI - приватный апи)
2. Модули ОС
3. Ядро (есть свой уровень api)

**API** - application programming interface
**UI** - user interface
**GUI**

Командная строка:

* cmd.exe -> batch `windows`
* bash sh zsh `GNU\Linux`

Используется скриптовый язык прогаммирования

Нативная (native `естественный`) операционная среда

Использование нативых апи - общение с нативной операционной средой



## Загрузка и отладка ОС

![](./photo_2018-09-13_10-38-10.jpg)

**ЦП** - центральный процессор

**АЛУ** - арифметико-логичское устройство

**ОЗУ** - оперативное запоминающее устройсто (энергозависимое)

**ПЗУ** - постоянное запоминающее устройство (энергонезависимое)

ПЗУ с ЦП не связаны напрямую, но шина обеспечивает связь многие-ко-многим

Подходы к архитектуре:

* Архитектура фон Неймана - `x86, x86-64, ARM`

* Принстонская архитектура - `AVM`

При запуске компьютера первым делом запускается `BIOS` (basic input output system)

Принцип `EEPROM`  устройства памяти, по которому работает `bios` 

Первым делам проходит `POST` - проверка целостности ЭВМ

`CMOS` - энергозависимое хранилище для настройки `bios`

Батарейка для `cmos` - `CR-2032 3.3v`

Первый 512 байт хд называются `MBR` (master boot record)

Дальше он передает управление самой ОС или загрузчику `Bootloader`:

* GRUB
* LiLo

**Более современные варианты**

BIOS -> UEFI

MBR -> GPT

Для отладки ОС используются виртуальные машины:

**VM** - Virtual Machine:

* VirtualBox
* VMWare
* DOSBox
* ePSXe

**Дамп (слепок)** - сохранение куска оперативной памяти, как есть, чтобы посмотреть, что произошло

При помощи виртуальных машин можно имитировать ошибку памяти и другие сбои

###  Парадигрмы программирования

* Императивные
  * Процедурные `C`
  * ООП `C Sharp Java`
* Декларативные
  * Функцилнальные `Prolog`
  * Логические `F#`

## Классификация операционных систем

* Количество одновременно работающих программ
  * Однопрограммные `MS DOS, FreeDos`
  * Многопрограммные
* По числу пользователей одновременно работающих в системе
  * Однопользовательские
  * Многопользовательские
*  По режиму исполнения
  * Пакетный `MS DOS`
  * Интерактивный
  * Режим реального времени `FreeDos QNX`
* По структуре
  * Монолитная OS
  * Иерархическая
  * Микроядерная
  * OS виртуальных машин
  * Мультипроцессорная
  * Сетевые

`time` - программа для запуска програм с прослеживанием времени работы программы

Возвращает время:

* real - по часам пользователям
* user - провела время в user режиме
* kernel / system - время ожидание, пока ядро находилось в kernel режиме

Если программа работала на одном процессере и без параллельных вычислений, тогда будет `user + system <= real`

Если процессоров несколько и паралелльные вычисления, то `user + system ? real`

Ядро бывает следующих **типов**:

* Монолитное
* Модульное
* Микроядро
* Гибридное

`modprobe` - управление модулями ядра в unix

`QNX` - микроядерная ОС реального времени. Микроядерность позволяет разместить ядро полностью в кеше процессора.

![1538631060404](./1538631060404.png)

### Мультипроцессорные ОС:

* **Сильносвязанные** - сильно связаны расстоянием (связаны шиной)
* **Слабосвязанные** - не связаны на прямую, связь только через

В однопроцессорной архитектуре ОС и прикладные программы выполняются в едином модуле, когда в мультпроцессорной архитектуре появляются проблемы организации выполнения ОС и прикладных программ.

Подходы для организации мультпроцессорной архитектуре (сильносвязанные):

* **Главный** - подчиненный
  Один процессор выбирается главным, на нем выполняется операционная система, а прикладные на остальных, при этом ОС жестко связывает процессор с процессом. ОС выполняется на едином модуле, поэтому она должна быть нереантерабельна.

* **Раздельные мониторы**
  На каждом из процессоров своя копия операционной системы, из-за чего все они равноправны
* **Симмитричная организация** (SMP - Symertical Multi Processoring)
  ОС является единой и находится на всех ОС сразу, используется динамическая балансировка нагрузки для распределения программ по процессорам. ОС должна быть реинтерабильна.

**Слабосвязанные** - на каждой выполняется своя копия ОС, связаны они не напрямую, а через некоторую линию связи

**Сетевая модель OSI** - стандарт обмена данными (ISO OSI)

1. Прикладной
2. Представительский
3. Сеансовый
4. Транспортный
5. Сетевой
6. Канальный
7. Физичиский

**Горизонтальная связь** - протокол (Прикладной - Прикладной)

**Вертикальная связь** - интерфейс (Прикладной - Представитеский)

**TCP/IP**:

1. Уровень приложений
2. Транспортный уровень
3. Уровеь сети Интернет
4. Уровень доступа к сети

**Сеть** - совокупность вычислительных узлов объедененных с помощью специального оборудования и программного обеспечения в единую сеть.

**VPN** (virtual private network) - эмуляция локальной сети поверх глобальной сети.

**Кластер (cluster)** - группа компьютеров объедененных друг с другом при помощи коммутационного обурудования, причем правило взаимодействия внутри кластера отличаются от правил взаимодействия снаружи.

**MPI** - библиотека, которая упрощает написание кластерных программ

**Масштубируемость** - увеличивание производительности за счет увеличение числа процессоров.

## Принципы построения современных ОС

Принципы организации 

1. Модульность

2. Частотная избирательность

   Выделение в алгоритмах системных программ и системных данных тех действий и той информации, которые используются наиболее часто

3. Функциональная избирательность

   Выбор наиболее важных функций ОС, которые должны быть выполнены наиболее эффективно и предаставлении им приоритета при распределении ресурсов.

4. Генерируемость

   Возможность настройки ОС при ее установке на вычислительную систему.

5. Наличие умолчаний

6. Настраиваемость

7. Перемещаемость

   Независимость работы программ от перемещения в памяти

8. Защищенность

9. Открытость

   ОС предоставляет инструменты для анализа себя

10. Наращиваемость

11. Независимость от внешних устройств

12. Функциональная избыточность

    Одну и ту же задачу можно решить сразу несколькими способами

13. Виртуализация ресурсов

    **Виртуализация** - формирования логических образов физических устройств

    Работает на двух принципах:

    * Разделение времени
    * Комбинирование физического устройства



**Процесс** - экземпляр программы запущенной на выполнение - сущность, объединяющие потоки

Жизненный цикл программы:

[исходный код] -компиляция-> [исполняемый файл] -команда ос-> -[процесс] -авто. создание-> [главный поток] -> [дочерние потоки]

**Поток (Thread)(тред)**  - часть контекста(код + данные) процесса связанное с решением опеределенной задачи

Все поток выполняются в едином адресном пространстве, то есть возможна их коммуникация

На стороне ЦП потоку соответствует определеная **задача** (Task)

**PCB** *(Process Control Block)* - память для хранения контекста задачи
**TCB** *(Thread Control Block)* - память для хранения контекста потока

* Контент регистров
* Сервисная информация

## Классификация процессов

1. По режиму выполнения
   * Пакетные
   * Интерактивные
   * Реального времени
2. По наличию связи между процессами
   * Изолированные (связей нет)
   * Связанные по данным
      * Файлы
      * Общая память
      * Сокеты
      * Сообщения
      * Сигналы
      * RPC
      * Каналы
3. Связаны в пространстве и по времени
4. Связь процессов по управлению
5. Отношения предшествования (функциональная связь)
6. Процессы по принадлежности к ОС
   * Системные
   * Прикладные
7. По принадлежности к ЦП
   * Внешние (не принадлежат)
   * Внутренние (принадлежат)

**Ресурс** - объект в составе вычислительной системы, обладающий свойством полезности

Ресурсы используются процессами во время выполнения.

В определенных ситуациях процессы выступают ресурсами для других процессов

## Классификация рессурсов

1. По реальности существвания
   * Физические
   * Виртуальные
2. По возможности виртуализации
   * Жесткие (нельзя виртуализировать)
   * Эластичные (можно виртуализации)
3. По структуре
   * Простые - нельзя разделить (ЦП)
   * Состовные - можно разделить (память)
4. По способу использования
   * Повторно используемые ресурсы (ПИР) захват - освобождение (например память)
   * Потребляемые ресурсы (ПР) порождение - захват - уничтожение (например энергия)
5. По времени жизни
   * Постоянные
   * Временные
6. По режиму использования
   * Последовательно-используемые ресурсы
   * Параллельно-используемые ресурсы
   * Разделяемые ресурсы
7. По степени активности
   * Активные - позволяют менять другие ресурсы
   * Пассивные
8. По степени важности
   * Главные
   * Второстепенные
9. По природе ресурсов
   * Аппаратные
   * Программные

## Жизненный цикл процесса / потока

1. Порождение
2. Готовность
3. Активность
4. Ожидание
5. Завершение
6. \+ Приостановка (для дебага)

Связи

1 -> 2 <-> 3 -> 4

4 -> 2

1, 2, 3, 4 -> 5

2, 4 <-> 6

2, 3, 4, 5 - Виртуальная машина (Виртуальный процесс)

На этапе порождения ОС формирует все необходимое для запуска процесса / потока 

Мультизадачность:

* Коорперативная
* Вытисняющая

Механизмы должны быть:

* Создания и уничтожения
* Активации и деактивации
* Блокировки и разблокировка
* Приостановки и возобновления

## Планирование и диспетчерезация

Есть планирование:

* Долгосрочное - ОС определяет каким процессам дозволено активно использовать ресурсы
* Среднесрочное - определение, какие процессы могут конкурировать за ЦП
* Краткосрочное (диспетчерезация) - определение в конкретный момент времени выдача ЦП конкретному потоку

* FIFO - очередь (первый вошел, первый уйдет)
* LIFO - стек
* Round Robin - закольцованная очередь

### Классиификация приоритеторв

* Изменямость
  * Статические - назначаются при старте и не меняются
  * Динамические
* По инициатору
  * Внешние - заданные извне (программист, пользователем)
  * Внутренние - определенные ОС

Дескриптор (описатель) 

В него входит:

* Идентификатор процесса (числовое)
* Приоритет - данные для планировщика
* Полномочия
* Текущие состояния
* Описание ВМ
  * PCB
  * Список потоков
  * Процесс, которым эти потоки поставлены
* Родитель
* Потомок
* ...

## Взаимные исключения

**Mutual exclusien**

Синхронизация

**Критическая секция** - последовательность команд программы по работе с разделяемыми функциями (параллельное выполнение этого участка кода несколькими потоками может привести к нарушению целостности общего ресурса)

Требования к критической секции:

1. В любой момент времени только один исполнитель может находится в своей критической секции по данному ресурсу
2. Ни один процесс не должен ждать бесконечно долго входа в свою критическую секцию
3. Ни один исполнительно не должен находится бесконечно долго в своей критической секции
4. Ни один исполнительно находящийся вне своей критической секции не должен задерживать выполнение других исполнителей, ожидающих входа в свои критические секции

Условия гонки *race condition* - внештатная ситуация, когда программный код начинает работать неправильно из-за неправильной работы с потоками

```
общая переменная:
int a = 0;

поток1:
while (true) a+=1;

поток2:
while (true) a+=1;
```
Вход в критическую секцию - захват ресурса на монопольное использование

Выход из кретической секции - освобождение ресурса

**Семафор** - защищенная переменная, значение которой можно опрашивать и изменять только при помощи специальных операций (семафорные примитивы)

Семафорные примитивы:

- Инициализация `init`
- Блокировка `lock` `P`
- Разблокировка `unlock` `V`

Семафор:

- Бинарные
- Двоичные - 1 или 0 - закрыт или открыт

- Считающие: 0 до +inf - используются для учета количества ресурса, если он состовной
- Общесчитающие: -inf до +inf, если значение > 0, значит ресурс открыт, иначе закрыт

Реализация семафора:

```
class BinSem{
  int s;
  list<Theards> tList;

  public:
    void int(int _s);
    void lock();
    void unlock();
}

void BinSen::init(int _s) {
  s = _s;
}

void BinSem::lock() {
  if (s == 0) {
    tLock.add(current());
    blockCurrent();
  } else {
    s = 0;
  }
}

void BinSem::unlock() {
  if (tList.empty()) {
    s = 1
  } else {
    Theard t = tList.first();
    tList.remove(t);
    resume(t);
  }
}
```

**Монитор синхронизации** - модуль, в котором общие ресурсы объеденяются с множеством процедур, реализующих доступ к ним